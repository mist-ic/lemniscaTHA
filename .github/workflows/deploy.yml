name: Deploy to Cloud Run

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'Dockerfile'
      - '.github/workflows/deploy.yml'

env:
  PROJECT_ID: lemnisca
  REGION: asia-south1
  SERVICE: clearpath-rag
  IMAGE: gcr.io/lemnisca/clearpath-rag

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      # Configure Docker to push to GCR
      - name: Configure Docker
        run: gcloud auth configure-docker --quiet

      # Cache Docker layers for faster rebuilds
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-docker-${{ hashFiles('backend/requirements.txt', 'frontend/package.json') }}
          restore-keys: |
            ${{ runner.os }}-docker-

      # Set up Docker Buildx for advanced caching
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build image with layer caching (skips unchanged layers)
      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE }}:${{ github.sha }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      # Prevent cache from growing indefinitely
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      # Deploy to Cloud Run
      - name: Deploy
        run: |
          gcloud run deploy ${{ env.SERVICE }} \
            --image ${{ env.IMAGE }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --memory 4Gi \
            --cpu 1 \
            --allow-unauthenticated \
            --set-env-vars "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}"

      # Get the deployed URL
      - name: Get URL
        id: url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $URL"

      # Run eval harness as quality gate
      - name: Run eval harness
        run: |
          pip install requests
          cd tests
          python eval_runner.py test_cases.json ${{ steps.url.outputs.url }}
          python eval_runner.py test_injection_defense.json ${{ steps.url.outputs.url }}
