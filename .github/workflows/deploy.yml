name: Deploy to Cloud Run

on:
  push:
    branches: [main]

env:
  PROJECT_ID: lemnisca
  REGION: asia-south1
  SERVICE: clearpath-rag
  IMAGE: gcr.io/lemnisca/clearpath-rag

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      # Configure Docker to push to GCR
      - name: Configure Docker
        run: gcloud auth configure-docker --quiet

      # Build image on GitHub runner (avoids Cloud Build quota issues)
      - name: Build image
        run: docker build -t ${{ env.IMAGE }}:${{ github.sha }} .

      # Push to Google Container Registry
      - name: Push image
        run: docker push ${{ env.IMAGE }}:${{ github.sha }}

      # Deploy to Cloud Run
      - name: Deploy
        run: |
          gcloud run deploy ${{ env.SERVICE }} \
            --image ${{ env.IMAGE }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --memory 4Gi \
            --cpu 1 \
            --allow-unauthenticated \
            --set-env-vars "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}"

      # Get the deployed URL
      - name: Get URL
        id: url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $URL"

      # Run eval harness as quality gate
      - name: Run eval harness
        run: |
          pip install requests
          cd tests
          python eval_runner.py test_cases.json ${{ steps.url.outputs.url }}
          python eval_runner.py test_injection_defense.json ${{ steps.url.outputs.url }}
